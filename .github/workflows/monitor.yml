name: Site Monitor

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"   # 매시간 정각(UTC 기준)
    #- cron: "*/10 * * * *"  # 10분마다
    # - cron: "0 9 * * 1" # 매주 월요일 09:00 (KST 아님: GitHub Actions cron은 UTC 기준)

permissions:
  contents: write

concurrency:
  group: site-monitor
  cancel-in-progress: false

jobs:
  monitor:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps
        run: npm install

      - name: Install Playwright (Chromium)
        run: npx playwright install --with-deps chromium

      # ✅ 여기서 실패해도 워크플로를 멈추지 않게 처리
      - name: Run monitor (do not stop on failure)
        id: monitor
        run: |
          set +e
          npm run monitor
          code=$?
          echo "exit_code=$code" >> $GITHUB_OUTPUT
          exit 0

      # ✅ 항상 reports를 커밋/푸시
      - name: Commit reports (always)
        if: always()
        run: |
          # Jekyll 비활성화(정적 파일/폴더 그대로 서빙)
          touch .nojekyll

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # ✅ .gitignore에 걸려도 reports를 강제로 스테이징
          git add -f -A reports .nojekyll

          if [ -n "$(git status --porcelain)" ]; then
            git commit -m "chore(reports): add run $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
            git push
          else
            echo "No changes to commit."
          fi

      # ✅ Slack 알림 (요약 + 대시보드 링크)
       - name: Notify Slack (summary + dashboard link)
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          # ✅ Secret이 없으면 조용히 스킵(워크플로 실패 안 함)
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "SLACK_WEBHOOK_URL is not set. Skipping Slack notification."
            exit 0
          fi

          node - <<'NODE'
          const fs = require('fs');

          const idx = JSON.parse(fs.readFileSync('reports/index.json','utf8'));
          const runRef = idx.runs[0];
          const run = JSON.parse(fs.readFileSync(runRef.runJson,'utf8'));

          const [owner, repo] = (process.env.GITHUB_REPOSITORY || '').split('/');
          const pagesBase = `https://${owner}.github.io/${repo}/`;
          const dash = `${pagesBase}#run=${encodeURIComponent(run.id)}`;

          const ok = run.overall === 'OK';
          const failedItems = (run.items || []).filter(x => x.status !== 'OK');
          const topFails = failedItems.slice(0, 10)
            .map(x => `• ${x.name} (${x.url})`)
            .join('\n') || '없음';

          const header = ok ? '✅ Site Monitor 결과 (이상없음)' : '⚠️ Site Monitor 결과 (실패 있음)';
          const statusLine = ok ? `전체 ${run.total}개 OK` : `${failedItems.length}/${run.total} FAIL`;

          const payload = {
            text: `${header} - ${statusLine}\n${dash}`,
            blocks: [
              { type:'header', text:{ type:'plain_text', text: header } },
              { type:'section', fields:[
                { type:'mrkdwn', text:`*Run ID:*\n${run.id}` },
                { type:'mrkdwn', text:`*Status:*\n${run.overall} (${run.failed}/${run.total})` },
                { type:'mrkdwn', text:`*Started:*\n${run.startedAt}` },
                { type:'mrkdwn', text:`*Duration:*\n${Math.round((run.durationMs||0)/1000)}s` }
              ]},
              { type:'section', text:{ type:'mrkdwn', text:`*Dashboard:*\n${dash}` } }
            ]
          };

          if (!ok) {
            payload.blocks.push({
              type:'section',
              text:{ type:'mrkdwn', text:`*실패 목록(최대 10개):*\n${topFails}` }
            });
          }

          fs.writeFileSync('slack_payload.json', JSON.stringify(payload));
          NODE

          curl -X POST -H 'Content-type: application/json' --data @slack_payload.json "$SLACK_WEBHOOK_URL"

      # (선택) Actions를 빨갛게 표시하고 싶으면 마지막에 실패 처리
      - name: Fail workflow if monitor failed
        if: ${{ steps.monitor.outputs.exit_code != '0' }}
        run: exit 1
